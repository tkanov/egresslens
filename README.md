# EgressLens

Monitor outbound network activity from Python apps in Docker. Trace connections with `strace`, generate JSONL logs for analysis, and explore results in a web UI.

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![Platform](https://img.shields.io/badge/platform-Linux%20%7C%20macOS-lightgrey.svg)](#prerequisites)
[![Docker 20.10+](https://img.shields.io/badge/docker-20.10+-2496ED.svg)](https://www.docker.com/)

---

## Prerequisites

- **Docker 20.10+**
- **Python 3.8+**
- **Linux/macOS**

---

## Installation

```bash
# Clone the repository
cd egresslens

# Install the CLI
pip install -e .
```

---

## Quick start

Trace a Python app quickly:

```bash
egresslens run-app ./sample_app --args "dns example.com"
```

**Output files:**
- `egresslens-output/egress.jsonl` - network events
- `egresslens-output/run.json` - run metadata
- `egresslens-output/cmd_stdout` - app stdout

---

## Usage

```bash
# Basic usage
egresslens run-app ./your_python_app

# With arguments
egresslens run-app ./your_python_app --args "arg1 arg2"
```

---

## Security

EgressLens uses `strace` and requires `ptrace`, so containers run with elevated capabilities and relaxed seccomp.

> **WARNING**: Isolation is therefore reduced. Treat traced apps as untrusted code ⚠️

### Required Docker settings

The CLI runs containers with:

| Setting | Purpose |
|---------|---------|
| `--cap-add SYS_PTRACE` | Required for `strace` to attach to processes |
| `--security-opt seccomp=unconfined` | Allows `ptrace` syscalls (blocked by default seccomp) |
| `--read-only` | Root filesystem is read-only |
| `tmpfs` for `/tmp` (100MB), `/root/.local` (100MB), `/root/.cache` (50MB) | Writable scratch space for strace, pip installs, and Python app output |
| `--cap-drop ALL` | Drops all capabilities except those explicitly added |
| `--security-opt no-new-privileges` | Prevents privilege escalation |

**Volume mounts:**

| Container path | Host path | Mode |
|----------------|-----------|------|
| `/work` | App directory | Read-only |
| `/output` | Output directory (e.g. `egresslens-output/`) | Read-write |

---

## Docker configuration

- Docker Engine 20.10+
- On Linux: your user must be in the `docker` group, or run with `sudo`

### Troubleshooting

#### "Operation not permitted" or ptrace errors

If you see `ptrace(PTRACE_TRACEME, ...)` errors:

1. **Verify capabilities** – ensure `--cap-add SYS_PTRACE` and `--security-opt seccomp=unconfined`.
2. **Check Docker daemon** – rootless Docker may block `ptrace`.
3. **SELinux/AppArmor** – policies may block `ptrace`.

#### Permission denied on mounted volume

The app directory is mounted read-only at `/work`. Write to `/tmp` or another tmpfs path. Tmpfs is provided for `/tmp` (100MB), `/root/.local` (100MB), and `/root/.cache` (50MB). Pip installs to `/tmp/pypackages` when `requirements.txt` is present.

#### Different Docker versions

- **Docker Desktop (Mac/Windows)** – runs containers in a Linux VM. EgressLens should work; ensure the Docker Desktop Linux VM has sufficient resources.
- **Podman** – podman's rootless mode may have limitations with `ptrace`. Prefer rootful Podman or Docker for EgressLens.
- **Kubernetes** – running EgressLens-style tracing in Kubernetes typically requires privileged pods.

### Building the base image

For best performance, build the image with strace pre-installed:

```bash
# From the project root
./docker-build.sh

# Or manually
docker build -t egresslens/base:latest .
```

Then run with:

```bash
egresslens run-app ./sample_app --image egresslens/base:latest --args "dns example.com"
```

The CLI defaults to `egresslens/base:latest`. You can override with `--image` (e.g. `--image ubuntu:24.04`), but custom images must include `strace`.

---

## Project structure

- **[cli/](cli/README.md)**  
  Command-line tool for running a user-specified command in a Docker container, tracing its network syscalls with `strace`, and generating JSONL event logs and run metadata. This is the main entrypoint for capturing egress data.

- **[sample_app/](sample_app/README.md)**  
  A tiny Python app used for testing EgressLens. It performs DNS lookups and queries [crt.sh](https://crt.sh/) for certificate transparency entries, providing predictable network activity for demo and test runs.

- **[backend/](backend/README.md)**  
  FastAPI backend *(in progress)* for uploading, aggregating, and serving reports generated by the CLI.

- **[frontend/](frontend/README.md)**  
  React + TypeScript web UI *(in progress)* for exploring egress analysis reports.

---

## Analyzing Python projects

`run-app` discovers entry points, installs dependencies if `requirements.txt` is present, and traces network activity.

**Entry points:** `__main__.py`, `main.py`, or `app.py`

